const I="passkeys_last_credentials",L="passkeys_site_credentials",F="passkeys_pending_account",T=["auth","login","signin","sign-in","sign_in","signup","sign-up","sign_up","password"],z=["signup","sign-up","sign_up","register","registration","create-account","create_account"],f=e=>{const t=e.getBoundingClientRect();return t.width>0&&t.height>0},A=()=>{const e=window.location.href.toLowerCase();return T.some(t=>e.includes(t))},C=()=>{const e=window.location.href.toLowerCase();return z.some(t=>e.includes(t))},O=()=>{const i=["ABCDEFGHJKLMNPQRSTUVWXYZ","abcdefghijkmnopqrstuvwxyz","23456789","!@#$%^&*()-_=+[]{}~"],l=u=>{const m=new Uint32Array(1);return crypto.getRandomValues(m),m[0]%u},d=i.join(""),c=[];for(i.forEach(u=>{c.push(u[l(u.length)])});c.length<16;)c.push(d[l(d.length)]);for(let u=c.length-1;u>0;u-=1){const m=l(u+1);[c[u],c[m]]=[c[m],c[u]]}return c.join("")},D=e=>Array.from(e.querySelectorAll('input[type="password"]')).find(n=>!n.disabled&&f(n))??null,Y=(e,t)=>{const s=Array.from(e.querySelectorAll('input[type="text"], input[type="email"], input[name*="user" i], input[name*="login" i], input[name*="email" i]')).filter(i=>!i.disabled&&f(i));if(t){const i=s.find(l=>l.type==="text"||l.type==="email");if(i)return i}return s[0]??null},q=e=>{const t=e.value.trim();if(!t)return null;let n=window.location.href,s=document.title.trim();try{const i=new URL(window.location.href);n=i.origin,s=i.hostname}catch{}return{url:n,label:s,username:"",password:t,createdAt:Date.now()}};let o=null;const S=()=>{o&&(o.remove(),o=null)},B=e=>{if(o)return;o=document.createElement("div"),o.style.position="fixed",o.style.left="50%",o.style.top="16px",o.style.transform="translateX(-50%)",o.style.zIndex="2147483647",o.style.background="#1f1f24",o.style.border="1px solid rgba(255, 255, 255, 0.1)",o.style.borderRadius="12px",o.style.padding="10px 12px",o.style.boxShadow="0 6px 20px rgba(0, 0, 0, 0.35)",o.style.fontFamily="system-ui, -apple-system, Segoe UI, sans-serif",o.style.fontSize="12px",o.style.color="white",o.style.display="flex",o.style.alignItems="center",o.style.gap="10px";const t=document.createElement("span");t.textContent="Сохранить учетные данные в Passkeys?",t.style.whiteSpace="nowrap";const n=document.createElement("button");n.type="button",n.textContent="Сохранить",n.style.background="#2E90FA",n.style.border="none",n.style.color="white",n.style.padding="6px 10px",n.style.borderRadius="8px",n.style.cursor="pointer",n.style.fontSize="12px";const s=document.createElement("button");s.type="button",s.textContent="Не сейчас",s.style.background="transparent",s.style.border="none",s.style.color="rgba(255, 255, 255, 0.7)",s.style.cursor="pointer",s.style.fontSize="12px",n.addEventListener("click",async()=>{var c;const i=x(),l=v(i),d={...e,username:(l==null?void 0:l.value.trim())??e.username};typeof chrome<"u"&&((c=chrome.storage)!=null&&c.local)&&await chrome.storage.local.set({[F]:d}),S()}),s.addEventListener("click",S),o.appendChild(t),o.appendChild(n),o.appendChild(s),document.body.appendChild(o)},K=e=>{const t=e.type;return(t==="password"||t==="text"||t==="email")&&!e.disabled&&!e.readOnly&&f(e)},x=()=>Array.from(document.querySelectorAll('input[type="password"]')).find(t=>!t.disabled&&f(t))??null,v=e=>{const n=Array.from(document.querySelectorAll('input[type="text"], input[type="email"], input[name*="user" i], input[name*="login" i]')).filter(s=>!s.disabled&&f(s));if(e){const s=e.closest("form");if(s){const l=Array.from(s.querySelectorAll("input")).find(d=>d.type!=="password"&&!d.disabled&&f(d)&&(d.type==="text"||d.type==="email"));if(l)return l}}return n[0]??null},p=(e,t)=>{e.focus(),e.value=t,e.dispatchEvent(new Event("input",{bubbles:!0})),e.dispatchEvent(new Event("change",{bubbles:!0}))},R=async()=>{var e;if(typeof chrome>"u"||!((e=chrome.storage)!=null&&e.local))return null;try{const t=new URL(window.location.href).origin,n=await chrome.storage.local.get([L,I]),s=n[L],i=s==null?void 0:s[t];return i||(n[I]??null)}catch{return null}},_=e=>{if(!e.url)return!0;try{const t=new URL(e.url),n=new URL(window.location.href);return t.origin===n.origin}catch{return!0}};let r=null,a=null,y=null,h=null;const M=()=>{r||(r=document.createElement("div"),r.style.position="absolute",r.style.zIndex="2147483647",r.style.background="#1f1f24",r.style.border="1px solid rgba(255, 255, 255, 0.1)",r.style.borderRadius="10px",r.style.padding="6px",r.style.display="none",r.style.boxShadow="0 6px 20px rgba(0, 0, 0, 0.3)",r.style.fontFamily="system-ui, -apple-system, Segoe UI, sans-serif",r.style.fontSize="12px",a=document.createElement("button"),a.type="button",a.style.background="#2E90FA",a.style.border="none",a.style.color="white",a.style.padding="6px 10px",a.style.borderRadius="8px",a.style.cursor="pointer",a.style.fontSize="12px",a.addEventListener("click",()=>{h&&h(),w()}),r.appendChild(a),r.addEventListener("mousedown",e=>{e.preventDefault()}),document.body.appendChild(r))},E=e=>{if(!r)return;const t=e.getBoundingClientRect(),n=t.top+window.scrollY,s=t.right+window.scrollX+8;r.style.top=`${n}px`,r.style.left=`${s}px`},g=(e,t,n)=>{M(),!(!r||!a)&&(y=e,h=n,a.textContent=t,E(e),r.style.display="block")},w=()=>{r&&(r.style.display="none"),y=null,h=null},k=(e,t)=>{const n=x(),s=v(n);s&&p(s,e),n&&p(n,t)},P=()=>{const e=x(),t=v(e);return{passwordInput:e,usernameInput:t}};let b=!1;const U=async()=>{if(b||!A())return;const e=await R();if(!e||!_(e))return;const{passwordInput:t,usernameInput:n}=P();t&&n?(p(n,e.username),p(t,e.password),b=!0):t?(p(t,e.password),b=!0):n&&(p(n,e.username),b=!0)};document.addEventListener("focusin",async e=>{const t=e.target;if(!(t instanceof HTMLInputElement)||!K(t)){w();return}if(!A()){w();return}if(C()&&t.type==="password"){g(t,"Сгенерировать пароль",()=>{const l=O();l&&p(t,l)});return}const n=await R();if(!n||!_(n)){w();return}const{passwordInput:s,usernameInput:i}=P();if(s&&i){g(t,"Вставить логин и пароль",()=>k(n.username,n.password));return}t.type==="password"?g(t,"Вставить пароль",()=>p(t,n.password)):g(t,"Вставить логин",()=>p(t,n.username))});document.addEventListener("mousedown",e=>{if(!r||r.style.display!=="block")return;const t=e.target;r.contains(t)||t===y||w()});document.addEventListener("scroll",()=>{y&&r&&r.style.display==="block"&&E(y)},!0);window.addEventListener("resize",()=>{y&&r&&r.style.display==="block"&&E(y)});document.addEventListener("DOMContentLoaded",()=>{U()});const N=new MutationObserver(()=>{U()});N.observe(document.documentElement,{childList:!0,subtree:!0});document.addEventListener("submit",e=>{if(!C())return;const t=e.target;if(!(t instanceof HTMLFormElement))return;const n=D(t);if(!n)return;const s=q(n);if(!s)return;const i=Y(t,n);i!=null&&i.value&&(s.username=i.value.trim()),B(s)},!0);chrome.runtime.onMessage.addListener((e,t,n)=>{if((e==null?void 0:e.type)!=="FILL_CREDENTIALS")return;const s=e.payload;k(s.username,s.password),n({ok:!0})});
